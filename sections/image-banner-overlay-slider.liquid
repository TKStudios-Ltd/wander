{%- liquid
  assign autoplay      = section.settings.autoplay
  assign duration_ms   = section.settings.duration_seconds | times: 1000
  assign show_dots     = section.settings.show_dots
  assign slides_count  = section.blocks.size
-%}

{%- if slides_count > 0 -%}
<section
  id="IBOS--{{ section.id }}"
  class="ibos"
  data-autoplay="{{ autoplay }}"
  data-interval="{{ duration_ms }}"
  style="--height-desktop: {{ section.settings.height_desktop }}; --height-mobile: {{ section.settings.height_mobile }};"
>
  <div class="swiper ibos__swiper">
    <div class="swiper-wrapper">
      {%- for block in section.blocks -%}
        {%- liquid
          assign d_img = block.settings.desktop_image
          assign m_img = block.settings.mobile_image | default: d_img
          assign col   = block.settings.collection

          # Title
          assign title = ''
          if block.settings.title_source == 'collection' and col
            assign title = col.title
          else
            assign title = block.settings.manual_title
          endif

          # Description
          assign desc_html = ''
          if block.settings.desc_source == 'collection' and col
            assign desc_html = col.description
          else
            assign desc_html = block.settings.manual_description
          endif

          # Eager load first when high on page
          assign load_eager = false
          if forloop.index0 == 0 and section.index < 3
            assign load_eager = true
          endif
          assign loading_attr        = load_eager | default: false | ternary: 'eager', 'lazy'
          assign fetchpriority_attr  = load_eager | default: false | ternary: 'high', 'auto'
        -%}

        <div class="swiper-slide" {{ block.shopify_attributes }}>
          <div class="ibos__slide">
            <div class="ibos__media">
              <picture>
                {%- if d_img != blank -%}
                  <source
                    media="(min-width: 750px)"
                    srcset="{{ d_img | image_url: width: 2400 }} 2400w,
                            {{ d_img | image_url: width: 2000 }} 2000w,
                            {{ d_img | image_url: width: 1600 }} 1600w,
                            {{ d_img | image_url: width: 1200 }} 1200w,
                            {{ d_img | image_url: width: 1000 }} 1000w,
                            {{ d_img | image_url: width: 800  }} 800w"
                    sizes="100vw">
                {%- endif -%}

                {%- assign img_mobile = m_img | default: d_img -%}
                {%- if img_mobile != blank -%}
                  <img
                    class="ibos__img"
                    alt="{{ block.settings.alt | escape }}"
                    loading="{{ loading_attr }}"
                    fetchpriority="{{ fetchpriority_attr }}"
                    src="{{ img_mobile | image_url: width: 1600 }}"
                    srcset="{{ img_mobile | image_url: width: 1600 }} 1600w,
                            {{ img_mobile | image_url: width: 1200 }} 1200w,
                            {{ img_mobile | image_url: width: 900  }} 900w,
                            {{ img_mobile | image_url: width: 700  }} 700w,
                            {{ img_mobile | image_url: width: 500  }} 500w"
                    sizes="100vw">
                {%- endif -%}
              </picture>
            </div>

            {%- comment -%} Overlay white box (desktop uses X/Y, mobile centered) {%- endcomment -%}
            <div class="ibos__overlay"
                 style="--x: {{ block.settings.pos_x | default: 50 }}%; --y: {{ block.settings.pos_y | default: 50 }}%; --maxw: {{ block.settings.box_max_width | default: 640 }}px;">
              <div class="ibos__box">
                {%- if title != blank -%}
                  {%- if col -%}
                    <a class="cbs__title collection__box__title" href="{{ col.url }}">
                      <em>WANDERINGS</em>™ COLLECTION:&nbsp;<b style="font-weight:700;">{{ title | escape }}</b>
                    </a>
                  {%- else -%}
                    <span class="cbs__title collection__box__title">
                      <em>WANDERINGS</em>™ COLLECTION:&nbsp;<b style="font-weight:700;">{{ title | escape }}</b>
                    </span>
                  {%- endif -%}
                {%- endif -%}

                {%- if desc_html != blank -%}
                  <div class="cbs__description h3 list-collections__item__title">
                    {{ desc_html }}
                  </div>
                {%- endif -%}

                {%- if block.settings.show_button and col -%}
                  <div class="ibos__cta">
                    <a class="btn btn--solid btn--large btn--black" href="{{ col.url }}">{{ block.settings.button_label | default: 'Shop the collection' }}</a>
                  </div>
                {%- endif -%}
              </div>
            </div>

          </div>
        </div>
      {%- endfor -%}
    </div>

    {%- if show_dots -%}
      <div class="swiper-pagination"></div>
    {%- endif -%}
  </div>
</section>

{%- style -%}
  #IBOS--{{ section.id }} { position: relative; width: 100%; overflow: clip; }
  #IBOS--{{ section.id }} .ibos__swiper { width: 100%; height: 100%; }
  #IBOS--{{ section.id }} .swiper-slide { position: relative; }
  #IBOS--{{ section.id }} .ibos__img {
    display:block;
    width:100%;
    height: var(--height-mobile, auto);
    object-fit: cover;
  }
  #IBOS--{{ section.id }} .ibos__overlay { position:absolute; inset:0; pointer-events:none; overflow: hidden; }
  #IBOS--{{ section.id }} .ibos__box {
    position:absolute;
    left: var(--x, 50%); top: var(--y, 50%);
    transform: translate(-50%, -50%);
    max-width: 600px;
    width: 600px;
    background: rgba(255,255,255, 0.75);
    color: var(--color-foreground, #000);
    border-radius: 0;
    padding: 4.5rem 2rem 4rem;
    pointer-events: auto;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #IBOS--{{ section.id }} .ibos__box .collection__box__title {
    background-color: #ebebeb;
  }
  #IBOS--{{ section.id }} .ibos__box .list-collections__item__title {
    margin: 1.5rem auto 0;
    text-align: center;
    font-size: 13px;
    line-height: 1.6;
    padding: 0;
    max-width: var(--maxw);
    width: var(--maxw);
  }
  #IBOS--{{ section.id }} .ibos__box .list-collections__item__title p {
    margin: 0;
  }
  #IBOS--{{ section.id }} .ibos__cta { margin-top: 20px; }
  #IBOS--{{ section.id }} .ibos__cta .btn { 
    --top-bottom-padding: 10px !important;
    --left-right-padding: 25px !important;
   }

  /* Dots: centered over image bottom */
  #IBOS--{{ section.id }} .swiper-pagination {
    position: absolute;
    left: 50%; bottom: 16px; transform: translateX(-50%);
    z-index: 3;
  }
  #IBOS--{{ section.id }} .swiper-pagination-bullet {
    width: 4px; height: 4px; opacity:.6; background: white;
    margin: 0 var(--swiper-pagination-bullet-horizontal-gap, 6px);
  }
  #IBOS--{{ section.id }} .swiper-pagination-bullet-active { opacity: 1; }

  @media (min-width: 750px) {
    #IBOS--{{ section.id }} .ibos__img { 
      height: var(--height-desktop, auto); 
      max-height: 880px;
    }
  }
  @media (min-width: 990px) {
    #IBOS--{{ section.id }} .ibos__box {
      transform: translate(-50%, -55%) scale(0.9) !important;
    }
  }
  @media (min-width: 750px) and (max-width: 989px) {
    #IBOS--{{ section.id }} .ibos__box {
      transform: translate(-50%, -55%) scale(0.75) !important;
    }
  }
  @media (max-width: 749px) {
    #IBOS--{{ section.id }} .ibos__box {
      transform: translate(-50%, -50%) scale(0.55) !important;
      left: 50% !important;
      top: 75% !important;
      /* max-width: 125vw !important;
      width: 125vw !important;
      padding: 4rem 1.5rem 3rem !important; */
    }
    /* #IBOS--{{ section.id }} .ibos__box .list-collections__item__title {
      max-width: calc(100% - 1rem);
      width: calc(100% - 1rem);
      padding: 0 0.5rem;
    } */
    /* #IBOS--{{ section.id }} .ibos__box .list-collections__item__title p {
      font-size: 12px;
    } */
  }

{%- endstyle -%}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var root = document.getElementById('IBOS--{{ section.id }}');
    if (!root) return;

    var autoplay = root.getAttribute('data-autoplay') === 'true';
    var interval = parseInt(root.getAttribute('data-interval'), 10) || 4000;

    var swiper = new Swiper(root.querySelector('.ibos__swiper'), {
      loop: {% if slides_count > 1 %}true{% else %}false{% endif %},
      speed: 500,
      autoplay: autoplay ? { delay: interval, disableOnInteraction: false } : false,
      pagination: {
        el: root.querySelector('.swiper-pagination'),
        clickable: true
      }
    });
  });
</script>
{%- else -%}
  <div class="page-width">
    <p>No slides added yet. Add blocks to “Image Banner Slider”.</p>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "Image Banner Slider",
  "class": "image-banner-overlay-slider",
  "settings": [
    { "type": "header", "content": "Slider behavior" },
    { "type": "checkbox", "id": "autoplay", "label": "Autoplay", "default": false },
    { "type": "range", "id": "duration_seconds", "label": "Change slide every (sec)", "min": 2, "max": 12, "step": 1, "default": 4 },
    { "type": "checkbox", "id": "show_dots", "label": "Show dot pagination", "default": true },

    { "type": "header", "content": "Height presets" },
    {
      "type": "select",
      "id": "height_desktop",
      "label": "Desktop height",
      "default": "clamp(400px, 45vw, 680px)",
      "options": [
        { "value": "auto", "label": "Adapt to image" },
        { "value": "400px", "label": "Small (400px)" },
        { "value": "550px", "label": "Medium (550px)" },
        { "value": "700px", "label": "Large (700px)" },
        { "value": "clamp(400px, 45vw, 680px)", "label": "Responsive (clamp 400–680px)" }
      ]
    },
    {
      "type": "select",
      "id": "height_mobile",
      "label": "Mobile height",
      "default": "750px",
      "options": [
        { "value": "auto", "label": "Adapt to image" },
        { "value": "400px", "label": "Small (400px)" },
        { "value": "600px", "label": "Medium (600px)" },
        { "value": "750px", "label": "Large (750px)" }
      ]
    }
  ],
  "blocks": [
    {
        "type": "slide",
        "name": "Slide",
        "settings": [
        { "type": "image_picker", "id": "desktop_image", "label": "Desktop image" },
        { "type": "image_picker", "id": "mobile_image", "label": "Mobile image (optional)" },
        { "type": "text", "id": "alt", "label": "Image alt text", "default": "Banner image" },

        { "type": "header", "content": "Content sources" },
        { "type": "collection", "id": "collection", "label": "Collection (for title/URL/desc)" },

        {
            "type": "select",
            "id": "title_source",
            "label": "Title source",
            "default": "collection",
            "options": [
            { "value": "collection", "label": "Use collection title" },
            { "value": "manual", "label": "Manual title" }
            ]
        },
        { "type": "text", "id": "manual_title", "label": "Manual title", "default": "Custom title" },

        {
            "type": "select",
            "id": "desc_source",
            "label": "Description source",
            "default": "manual",
            "options": [
            { "value": "collection", "label": "Use collection description" },
            { "value": "manual", "label": "Manual description (rich text)" }
            ]
        },
        { "type": "richtext", "id": "manual_description", "label": "Manual description", "default": "<p>Custom description</p>" },

        { "type": "checkbox", "id": "show_button", "label": "Show CTA button", "default": true },
        { "type": "text", "id": "button_label", "label": "Button label", "default": "Shop the collection" },

        { "type": "header", "content": "Overlay box (desktop position)" },
        { "type": "range", "id": "pos_x", "label": "Horizontal position (X)", "min": 0, "max": 100, "step": 1, "default": 50, "unit": "%" },
        { "type": "range", "id": "pos_y", "label": "Vertical position (Y)", "min": 0, "max": 100, "step": 1, "default": 50, "unit": "%" },
        { "type": "range", "id": "box_max_width", "label": "Max width (px)", "min": 280, "max": 900, "step": 10, "default": 640 }
        ]
    }
  ],
  "presets": [
    { 
        "name": "Image Banner Slider", 
        "category": "Image" 
    }
  ],
  "disabled_on": { "groups": ["header", "aside", "footer"] }
}
{% endschema %}
