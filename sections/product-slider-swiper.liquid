{%- liquid
  assign collection = collections[section.settings.collection]
  assign title = section.settings.title
  assign text = section.settings.text
  assign button_text = section.settings.button_text
  assign limit = section.settings.number_of_products | default: 8
  assign swym_enabled = section.settings.swym_enabled
-%}

<style>
    .section-{{ section.id }}-padding { 
        padding-top: var(--pt); 
        padding-bottom: var(--pb); 
    }
    @media screen and (min-width: 750px) {
      .section-{{ section.id }}-padding { 
            padding-top: var(--pt-desktop); 
            padding-bottom: var(--pb-desktop); 
        }
    }
    @media screen and (max-width: 749px) {
        .wrapper--full-padded {
            padding-right: 0;
        }
    }

    .product-slider-swiper .product-slider-swiper__header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:24px;
      margin-bottom:24px;
    }
    .product-slider-swiper__title h3 {
        font-size: 2rem;
        line-height: 1;
    }
    @media (max-width: 767px) {
      .product-slider-swiper__title h3 {
        font-size: calc(2rem * 0.8) !important;
      }
    }
    .product-slider-swiper .product-slider-swiper__header.text-center{
      align-items:center;
      text-align:center;
      flex-direction:column;
    }
    .product-slider-swiper .product-slider-swiper__header.text-right{ text-align:right; }

    .product-slider-swiper .swiper-{{ section.id }} { width:100%; }
    .product-slider-swiper .swiper-{{ section.id }} .swiper-slide{ height:auto; }

    .product-slider-swiper .swiper-button-next-{{ section.id }},
    .product-slider-swiper .swiper-button-prev-{{ section.id }}{
      display:block;
      width:auto;
    }

    main .swiper-pagination-{{ section.id }}{
      width: fit-content !important;
      left: 50% !important;
      transform: translateX(-50%);
    }
    /* Prevent slide contents from overflowing on small screens */
    .product-slider-swiper .swiper-{{ section.id }} {
    overflow: hidden;
    }

    .product-slider-swiper .swiper-{{ section.id }} .swiper-slide {
    overflow: hidden;
    box-sizing: border-box;
    }

    .product-slider-swiper .swiper-{{ section.id }} .swiper-slide > * {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    min-width: 0;
    }

    /* Your card wrapper (based on your product-card.liquid structure) */
    .product-slider-swiper .swiper-{{ section.id }} .swiper-slide .grid-item,
    .product-slider-swiper .swiper-{{ section.id }} .swiper-slide .image-wrapper,
    .product-slider-swiper .swiper-{{ section.id }} .swiper-slide .product-card,
    .product-slider-swiper .swiper-{{ section.id }} .swiper-slide .product-card__link {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    }

    /* Images should never push outside */
    .product-slider-swiper .swiper-{{ section.id }} img {
    max-width: 100%;
    height: auto;
    display: block;
    }

</style>

<section
  class="product-slider-swiper section-{{ section.id }}-padding"
  style="
    --pt: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    --pt-desktop: {{ section.settings.padding_top }}px;
    --pb: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    --pb-desktop: {{ section.settings.padding_bottom }}px;
  "
  data-product-slider-swiper
>
  <div class="{{ section.settings.width }}">
    {%- if title != blank or text != blank or button_text != blank -%}
      <div class="product-slider-swiper__header {{ section.settings.text_alignment }}">
        <div class="product-slider-swiper__header-left">
          {%- if title != blank -%}
            <div class="product-slider-swiper__title">{{ title }}</div>
          {%- endif -%}
          {%- if text != blank -%}
            <div class="product-slider-swiper__text">{{ text }}</div>
          {%- endif -%}
        </div>

        {%- if button_text != blank -%}
          <div class="product-slider-swiper__header-right">
            <a class="btn {{ section.settings.button_style }} {{ section.settings.button_size }} {{ section.settings.button_color }}"
               href="{{ collection.url | default: '#!' }}">
              {{ button_text }}
            </a>
          </div>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- if collection and collection.products_count > 0 -%}
      <div class="swiper swiper-{{ section.id }}"
        data-slides-desktop="{{ section.settings.slides_per_view_desktop }}"
        data-slides-tablet="{{ section.settings.slides_per_view_tablet }}"
        data-slides-mobile="{{ section.settings.slides_per_view_mobile }}"
        data-space-desktop="{{ section.settings.space_between_desktop }}"
        data-space-mobile="{{ section.settings.space_between_mobile }}"
        data-loop="{{ section.settings.loop }}"
        data-autoplay="{{ section.settings.autoplay }}"
        data-autoplay-delay="{{ section.settings.autoplay_delay }}"
        data-speed="{{ section.settings.speed }}"
      >
        <div class="swiper-wrapper">
          {%- for product in collection.products limit: limit -%}
            <div class="swiper-slide lifestyle--product">
              {%- render 'product-card', product: product, swym_enabled: swym_enabled -%}
            </div>
          {%- endfor -%}
        </div>

        {%- if section.settings.show_pagination -%}
          <div class="swiper-pagination swiper-pagination-{{ section.id }}"></div>
        {%- endif -%}

        {%- if section.settings.show_arrows -%}
          <div class="swiper-button-next swiper-button-next-{{ section.id }}"></div>
          <div class="swiper-button-prev swiper-button-prev-{{ section.id }}"></div>
        {%- endif -%}
      </div>
    {%- else -%}
      <p>No products found.</p>
    {%- endif -%}
  </div>

</section>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css">
<script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js" defer></script>

<script>
    (function () {
      function init() {
        if (typeof Swiper === 'undefined') {
          setTimeout(init, 100);
          return;
        }

        var el = document.querySelector('.swiper-{{ section.id }}');
        if (!el) return;

        // if already initialised, destroy first
        if (el.swiper && typeof el.swiper.destroy === 'function') {
          try { el.swiper.destroy(true, true); } catch(e) {}
        }

        var slidesDesktop = parseFloat(el.getAttribute('data-slides-desktop')) || 4;
        var slidesTablet  = parseFloat(el.getAttribute('data-slides-tablet')) || 3;
        var slidesMobile  = parseFloat(el.getAttribute('data-slides-mobile')) || 1.2;

        var spaceDesktop  = parseInt(el.getAttribute('data-space-desktop'), 10);
        var spaceMobile   = parseInt(el.getAttribute('data-space-mobile'), 10);
        if (isNaN(spaceDesktop)) spaceDesktop = 20;
        if (isNaN(spaceMobile)) spaceMobile = 20;

        var loop = (el.getAttribute('data-loop') === 'true');
        var autoplayEnabled = (el.getAttribute('data-autoplay') === 'true');
        var autoplayDelay = parseInt(el.getAttribute('data-autoplay-delay'), 10);
        if (isNaN(autoplayDelay)) autoplayDelay = 3500;

        var speed = parseInt(el.getAttribute('data-speed'), 10);
        if (isNaN(speed)) speed = 450;

        var opts = {
          slidesPerView: slidesMobile,
          spaceBetween: spaceMobile,
          speed: speed,
          loop: loop,
          watchOverflow: true,
          breakpoints: {
            750:  { slidesPerView: slidesTablet,  spaceBetween: spaceDesktop },
            1200:  { slidesPerView: slidesDesktop, spaceBetween: spaceDesktop }
          }
        };

        {% if section.settings.show_arrows %}
          opts.navigation = {
            nextEl: '.swiper-button-next-{{ section.id }}',
            prevEl: '.swiper-button-prev-{{ section.id }}'
          };
        {% endif %}

        {% if section.settings.show_pagination %}
          opts.pagination = {
            el: '.swiper-pagination-{{ section.id }}',
            clickable: true
          };
        {% endif %}

        if (autoplayEnabled) {
          opts.autoplay = { delay: autoplayDelay, disableOnInteraction: false };
        }

        try {
          new Swiper('.swiper-{{ section.id }}', opts);
        } catch (e) {
          console.log('Swiper init failed');
          console.log(e);
        }
      }

      init();

      if (window.Shopify && Shopify.designMode) {
        document.addEventListener('shopify:section:load', function (event) {
          if (event && event.detail && event.detail.sectionId === '{{ section.id }}') {
            init();
          }
        });
      }
    })();
</script>

{% schema %}
{
  "name": "Product Slider (Swiper)",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },

    {
      "type": "header",
      "content": "Text"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text alignment",
      "default": "text-left",
      "options": [
        { "label": "Left", "value": "text-left" },
        { "label": "Center", "value": "text-center" },
        { "label": "Right", "value": "text-right" }
      ]
    },
    {
      "type": "richtext",
      "id": "title",
      "label": "Heading",
      "default": "<p>Shop Collection</p>"
    },
    {
      "type": "richtext",
      "id": "text",
      "label": "Text"
    },

    {
      "type": "header",
      "content": "Button"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Text"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Link",
      "info": "Leave blank to link to the selected collection"
    },
    {
      "type": "select",
      "id": "button_color",
      "label": "Button color",
      "default": "btn--black",
      "options": [
        { "label": "Primary", "value": "btn--primary" },
        { "label": "Secondary", "value": "btn--secondary" },
        { "label": "White", "value": "btn--white" },
        { "label": "Black", "value": "btn--black" }
      ]
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button style",
      "default": "btn--text",
      "options": [
        { "label": "Solid", "value": "btn--solid" },
        { "label": "Outline", "value": "btn--outline" },
        { "label": "Solid with border", "value": "btn--solid-border" },
        { "label": "Text", "value": "btn--text" }
      ]
    },
    {
      "type": "select",
      "id": "button_size",
      "label": "Size",
      "default": "btn--large",
      "options": [
        { "label": "Large", "value": "btn--large" },
        { "label": "Medium", "value": "btn--medium" },
        { "label": "Small", "value": "btn--small" }
      ]
    },

    {
      "type": "header",
      "content": "Products"
    },
    {
      "type": "range",
      "id": "number_of_products",
      "label": "Products",
      "default": 8,
      "min": 1,
      "max": 48,
      "step": 1
    },
    {
      "type": "checkbox",
      "id": "swym_enabled",
      "label": "Enable wishlist (Swym)",
      "default": false
    },

    {
      "type": "header",
      "content": "Slider"
    },
    {
      "type": "range",
      "id": "slides_per_view_desktop",
      "label": "Slides per view (desktop)",
      "default": 4,
      "min": 1,
      "max": 6,
      "step": 1
    },
    {
      "type": "range",
      "id": "slides_per_view_tablet",
      "label": "Slides per view (tablet)",
      "default": 3,
      "min": 1,
      "max": 6,
      "step": 1
    },
    {
      "type": "range",
      "id": "slides_per_view_mobile",
      "label": "Slides per view (mobile)",
      "default": 1.2,
      "min": 1,
      "max": 2,
      "step": 0.1
    },
    {
      "type": "range",
      "id": "space_between_desktop",
      "label": "Gap (desktop)",
      "default": 24,
      "min": 0,
      "max": 60,
      "step": 2,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "space_between_mobile",
      "label": "Gap (mobile)",
      "default": 16,
      "min": 0,
      "max": 60,
      "step": 2,
      "unit": "px"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_scrollbar",
      "label": "Show scrollbar",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "loop",
      "label": "Loop",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Autoplay",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_delay",
      "label": "Autoplay delay",
      "default": 3500,
      "min": 1000,
      "max": 9000,
      "step": 250,
      "unit": "ms"
    },
    {
      "type": "range",
      "id": "speed",
      "label": "Transition speed",
      "default": 450,
      "min": 200,
      "max": 1200,
      "step": 50,
      "unit": "ms"
    },

    {
      "type": "header",
      "content": "Section spacing"
    },
    {
      "type": "select",
      "id": "width",
      "label": "Width",
      "default": "wrapper--full-padded",
      "options": [
        { "value": "wrapper", "label": "Page width" },
        { "value": "wrapper--full-padded", "label": "Full width padded" }
      ]
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 2,
      "unit": "px",
      "label": "Padding top",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 2,
      "unit": "px",
      "label": "Padding bottom",
      "default": 60
    }
  ],
  "presets": [
    {
      "name": "Product Slider (Swiper)",
      "category": "Collection"
    }
  ],
  "disabled_on": {
    "groups": ["header","aside"]
  }
}
{% endschema %}
