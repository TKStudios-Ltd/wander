{%- liquid
  assign unique = section.id
  assign section_height = section.settings.height
  assign enable_mobile_height = section.settings.enable_mobile_height
  assign mobile_height = section.settings.mobile_height
  assign image = section.settings.image
  assign mobile_image = section.settings.mobile_image
  assign image_width = image.width
  assign image_alt = image.alt | strip_html | escape
  assign mobile_image_alt = mobile_image.alt | strip_html | escape
  assign image_stretch = section.settings.enable_stretch
  assign image_position = section.settings.image_position
  assign bg_color_secondary = section.settings.bg_color_secondary
  assign section_width = section.settings.width
  assign animations_enabled = settings.animations_enabled
  assign animation_anchor = '#Image--' | append: unique
  assign animation_delay = 150
  assign allow_mobile_zoom = section.settings.allow_mobile_zoom

  assign anchor_id = 'Image--' | append: unique
  if section.settings.custom_id != blank
    assign anchor_id = section.settings.custom_id | strip | handle
  endif
  assign animation_anchor = '#' | append: anchor_id

  capture image_classes
    echo 'section-image__image'
    if image == blank and image_stretch
      echo ' placeholder-svg-rect'
    endif
  endcapture

  # Web-optimised caps (adjust if needed)
  assign MAX_DESKTOP_W = 2000
  assign MAX_MOBILE_W  = 1200

  # IMPORTANT: keep this list <= max caps so srcset never serves print-ready sizes
  assign image_widths = '180, 360, 540, 720, 900, 1080, 1200, 1600, 2000'

  assign desktop_space = 120
  assign tablet_space = 40
  assign mobile_space = 40
  case section_width
    when 'wrapper--full'
      assign wrapper_width = '100vw'
      assign desktop_space = 0
      assign tablet_space = 0
      assign mobile_space = 0
    when 'wrapper--full-padded'
      assign wrapper_width = '100vw'
    when 'wrapper'
      assign wrapper_width = '1440px'
    when 'wrapper--narrow'
      assign wrapper_width = '840px'
  endcase

  assign img_width_lg = 'calc(' | append: wrapper_width | append: ' - ' | append: desktop_space | append: 'px)'
  assign img_width_md = 'calc(100vw - ' | append: tablet_space | append: 'px)'
  assign img_width_sm = 'calc(100vw - ' | append: mobile_space | append: 'px)'

  unless image_stretch
    capture settings_height
      case section_height
        when 'full-height' then echo '100vh'
        when 'three-quarters-height' then echo '75vh'
        when 'two-thirds-height' then echo '66vh'
        when 'one-half-height' then echo '50vh'
        when 'one-third-height' then echo '33vh'
        when 'one-fifth-height' then echo '20vh'
        when 'seven-fifty-height' then echo '750px'
        when 'six-fifty-height' then echo '650px'
        when 'five-fifty-height' then echo '550px'
        when 'four-fifty-height' then echo '450px'
        when 'original-height' then echo image.height | append: 'px'
      endcase
    endcapture

    capture settings_height_sm
      case mobile_height
        when 'full-height' then echo '100vh'
        when 'three-quarters-height' then echo '75vh'
        when 'two-thirds-height' then echo '66vh'
        when 'one-half-height' then echo '50vh'
        when 'one-third-height' then echo '33vh'
        when 'one-fifth-height' then echo '20vh'
        when 'seven-fifty-height' then echo '750px'
        when 'six-fifty-height' then echo '650px'
        when 'five-fifty-height' then echo '550px'
        when 'four-fifty-height' then echo '450px'
        when 'original-height' then echo image.height | append: 'px'
      endcase
    endcapture

    capture rendered_image_width
      echo '('
      echo image.aspect_ratio
      echo ' * '
      echo settings_height
      echo ')'
    endcapture
    capture rendered_image_width_sm
      echo '('
      echo image.aspect_ratio
      echo ' * '
      echo settings_height_sm
      echo ')'
    endcapture

    assign img_width_lg = 'min(' | append: rendered_image_width | append: ', (' | append: wrapper_width | append: ' - ' | append: desktop_space | append: 'px))'
    assign img_width_md = 'min(' | append: rendered_image_width | append: ', (100vw - ' | append: tablet_space | append: 'px))'

    if enable_mobile_height
      assign rendered_image_width = rendered_image_width_sm
    endif
    assign img_width_sm = 'min(' | append: rendered_image_width | append: ', (100vw - ' | append: mobile_space | append: 'px))'
  endunless

  assign sizes_default = '(min-width: 1024px) ' | append: img_width_lg | append: ', (min-width: 768px) ' | append: img_width_md | append: ', ' | append: img_width_sm

  comment
    When allow_mobile_zoom is true:
    - On mobile we do NOT clamp sizes to viewport
    - We'll give the browser a large size so it requests a large srcset
    We cap this to MAX_DESKTOP_W to avoid serving print-ready images.
  endcomment

  assign sizes_zoom_mobile = '(min-width: 1024px) ' | append: img_width_lg | append: ', (min-width: 768px) ' | append: img_width_md | append: ', ' | append: MAX_DESKTOP_W | append: 'px'

  assign sizes = sizes_default
  if allow_mobile_zoom
    assign sizes = sizes_zoom_mobile
  endif
-%}

{%- style -%}
  #Image--{{ unique }} {
    --PT: {{ section.settings.padding_top }}px;
    --PB: {{ section.settings.padding_bottom }}px;
  }

  .section-image__mobile {
    display: none;
  }

  .section-image__desktop {
    width: 100%;
  }

  {% if mobile_image %}
  @media screen and (max-width: 749px) {
    .section-image__desktop {
      display: none;
    }
    .section-image__mobile {
      display: block;
    }
  }
  {% endif %}

  /* zoom/pan mode on mobile */
  @media screen and (max-width: 749px) {
    {% if allow_mobile_zoom %}
    .section-image__zoom-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }

    .section-image__zoom-inner {
      display: inline-block;
      /* do not force max-width:100% so it can be wider than viewport */
    }

    .section-image__zoom-inner img {
      height: auto;
      width: auto;
      max-width: none;
      /* prevent responsive CSS from squashing it */
      display: block;
    }
    {% endif %}
  }
{%- endstyle -%}

<section id="{{ anchor_id }}"
  class="section-padding section-image{% if image_stretch %} section-image--stretch{% endif %} section-image--{{ image_position }}{% if bg_color_secondary %} bg-secondary{% endif %}"
  data-section-id="{{ unique }}"
  data-section-type="image">
  <div class="{{ section_width }}">
    <div class="section-image__container {{ section_height }}{% if enable_mobile_height %} {{ mobile_height }}{% endif %}"
      {% if animations_enabled %}
        data-aos="fade-up"
        data-aos-anchor="{{ animation_anchor }}"
        data-aos-delay="{{ animation_delay }}"
        {%- assign animation_delay = animation_delay | plus: 150 -%}
      {% endif %}>

      {%- comment -%}
        DESKTOP / TABLET IMAGE
      {%- endcomment -%}
      <div class="section-image__desktop">
        {%- render 'image',
          image: image,
          width: MAX_DESKTOP_W,
          widths: image_widths,
          sizes: sizes,
          alt: image_alt,
          cover: image_stretch,
          classes: image_classes,
          placeholder_svg: 'lifestyle-1' -%}
      </div>

      {%- comment -%}
        MOBILE IMAGE
        If allow_mobile_zoom:
        - wrap img in scroll container so user can pan horizontally
        Else:
        - normal behaviour (100% fluid)
      {%- endcomment -%}
      {% if mobile_image %}
        {% if allow_mobile_zoom %}
          <div class="section-image__mobile">
            <div class="section-image__zoom-wrapper">
              <div class="section-image__zoom-inner">
                {%- render 'image',
                  image: mobile_image,
                  width: MAX_MOBILE_W,
                  widths: image_widths,
                  sizes: sizes,
                  alt: mobile_image_alt,
                  cover: false,
                  classes: image_classes,
                  placeholder_svg: 'lifestyle-1' -%}
              </div>
            </div>
          </div>
        {% else %}
          <div class="section-image__mobile">
            {%- render 'image',
              image: mobile_image,
              width: MAX_MOBILE_W,
              widths: image_widths,
              sizes: sizes,
              alt: mobile_image_alt,
              cover: true,
              classes: image_classes,
              placeholder_svg: 'lifestyle-1' -%}
          </div>
        {% endif %}
      {% endif %}
    </div>
  </div>
</section>


{% schema %}
{
  "name": "Image",
  "class": "Image",
  "settings": [
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image"
    },
    {
      "type": "image_picker",
      "id": "mobile_image",
      "label": "Mobile Image"
    },
    {
      "type": "checkbox",
      "id": "allow_mobile_zoom",
      "label": "Allow oversized mobile image (pan to zoom)",
      "default": false,
      "info": "If checked, the mobile image will not be scaled down to fit the screen. Instead it can scroll horizontally so users can inspect detail."
    },
    {
      "type": "header",
      "content": "Anchor"
    },
    {
      "type": "text",
      "id": "custom_id",
      "label": "Custom anchor ID",
      "info": "Optional. Used for #hash links"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "height",
      "label": "Height",
      "default": "original-height",
      "options": [
        { "value": "full-height", "label": "Full screen" },
        { "value": "three-quarters-height", "label": "Three quarters of screen" },
        { "value": "two-thirds-height", "label": "Two thirds of screen" },
        { "value": "one-half-height", "label": "One half of screen" },
        { "value": "one-third-height", "label": "One third of screen" },
        { "value": "one-fifth-height", "label": "One fifth of screen" },
        { "value": "seven-fifty-height", "label": "750px" },
        { "value": "six-fifty-height", "label": "650px" },
        { "value": "five-fifty-height", "label": "550px" },
        { "value": "four-fifty-height", "label": "450px" },
        { "value": "original-height", "label": "Image height" }
      ]
    },
    {
      "type": "checkbox",
      "id": "enable_mobile_height",
      "label": "Enable mobile height",
      "default": false
    },
    {
      "type": "select",
      "id": "mobile_height",
      "label": "Mobile height",
      "default": "original-height",
      "options": [
        { "value": "full-height", "label": "Full screen" },
        { "value": "three-quarters-height", "label": "Three quarters of screen" },
        { "value": "two-thirds-height", "label": "Two thirds of screen" },
        { "value": "one-half-height", "label": "One half of screen" },
        { "value": "one-third-height", "label": "One third of screen" },
        { "value": "one-fifth-height", "label": "One fifth of screen" },
        { "value": "seven-fifty-height", "label": "750px" },
        { "value": "six-fifty-height", "label": "650px" },
        { "value": "five-fifty-height", "label": "550px" },
        { "value": "four-fifty-height", "label": "450px" },
        { "value": "original-height", "label": "Image height" }
      ]
    },
    {
      "type": "checkbox",
      "id": "enable_stretch",
      "label": "Stretch image",
      "default": true,
      "info": "Desktop only"
    },
    {
      "type": "select",
      "id": "image_position",
      "label": "Image position",
      "default": "center",
      "info": "Applies if no stretch image checked",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "checkbox",
      "id": "bg_color_secondary",
      "label": "Background",
      "info": "Use secondary background color",
      "default": false
    },
    {
      "type": "header",
      "content": "Section spacing"
    },
    {
      "type": "select",
      "id": "width",
      "label": "Width",
      "default": "wrapper--full-padded",
      "options": [
        { "value": "wrapper--full", "label": "Full width" },
        { "value": "wrapper--full-padded", "label": "Full width padded" },
        { "value": "wrapper", "label": "Page width" },
        { "value": "wrapper--narrow", "label": "Page width narrow" }
      ]
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 2,
      "unit": "px",
      "label": "Padding top",
      "default": 100
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 200,
      "step": 2,
      "unit": "px",
      "label": "Padding bottom",
      "default": 100
    }
  ],
  "presets": [
    {
      "name": "Image",
      "category": "Image"
    }
  ],
  "disabled_on": {
    "groups": ["header","aside"]
  }
}
{% endschema %}
